---
- name: Configure Debian host
  hosts: all
  remote_user: root
  become: true

  tasks:
    - name: Install packages
      ansible.builtin.apt:
        name:
          - sudo
          - gpg
          - ufw
          - vim
          - mc
          - btop
          - git
          - curl
          - wget
          - powertop
          - smartmontools
          - bash-completion
          - fastfetch
        state: present
        update_cache: true

    - name: Download Tailscale GPG key
      ansible.builtin.uri:
        url: https://pkgs.tailscale.com/stable/debian/trixie.noarmor.gpg
        dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
        creates: /usr/share/keyrings/tailscale-archive-keyring.gpg
        mode: '0644'

    - name: Tailscale repository
      ansible.builtin.uri:
        url: https://pkgs.tailscale.com/stable/debian/trixie.tailscale-keyring.list
        dest: /etc/apt/sources.list.d/tailscale.list
        creates: /etc/apt/sources.list.d/tailscale.list
        mode: '0644'

    - name: Install Tailscale
      ansible.builtin.apt:
        name: tailscale
        state: present
        update_cache: true

    - name: Generate Tailscale completion
      ansible.builtin.command: tailscale completion bash
      register: tailscale_completion_output
      changed_when: false

    - name: Write Tailscale completion
      ansible.builtin.copy:
        content: "{{ tailscale_completion_output.stdout }}"
        dest: /etc/bash_completion.d/tailscale
        creates: /etc/bash_completion.d/tailscale
        mode: '0644'
